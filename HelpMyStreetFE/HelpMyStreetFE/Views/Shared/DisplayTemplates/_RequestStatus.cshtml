@using System.Linq;
@using HelpMyStreet.Utils.Enums;
@using HelpMyStreet.Utils.Extensions;
@using HelpMyStreetFE.Helpers;
@using HelpMyStreetFE.Models.Account.Jobs;

@model IEnumerable<KeyValuePair<JobStatuses, int>>;

@{

    JobStatuses? singleStatus = null;
    Dictionary<JobStatuses, int> unCancelledStatuses = null;
    int totalUncancelledJobs = 0;
    bool allJobsAccepted = true;

    List<StatusCircleSegment> segments = new List<StatusCircleSegment>();

    if (Model.All(s => s.Key.Equals(JobStatuses.Cancelled)))
    {
        singleStatus = JobStatuses.Cancelled;
    }
    else
    {
        unCancelledStatuses = Model.Where(s => !s.Key.Equals(JobStatuses.Cancelled)).ToDictionary(a => a.Key, a => a.Value);
        totalUncancelledJobs = unCancelledStatuses.Sum(s => s.Value);

        if (unCancelledStatuses.Count() == 1)
        {
            singleStatus = unCancelledStatuses.First().Key;
        }

        int offsetJobs = 0;

        foreach (var s in unCancelledStatuses.OrderBy(s => s.Key.UsualOrderOfProgression()))
        {
            segments.Add(new StatusCircleSegment
            {
                JobStatus = s.Key,
                Radius = 1.3,
                Proportion = (double)s.Value / totalUncancelledJobs,
                GapProportion = 0.01,
                OffsetProportion = (double)offsetJobs / totalUncancelledJobs
            });

            offsetJobs += s.Value;

            if (s.Key.Equals(JobStatuses.Open))
            {
                allJobsAccepted = false;
            }
        }
    }
}


@if (singleStatus != null)
{
    <img class="status-icon" src="~/img/icons/status/@singleStatus.Value.Icon()" alt="@singleStatus.Value.FriendlyName()" />
    <span class="job__status">@singleStatus.Value.FriendlyName()</span>
}
else
{
    <div class="status-icon">
        <svg>

            @foreach (var segment in segments.Where(s => s.JobStatus.Equals(JobStatuses.Accepted)))
            {
                <circle class="@segment.JobStatus.Class()" cx="50%" cy="50%" r="@segment.R" style="stroke-dashoffset: @segment.DashOffset; stroke-dasharray: @segment.DashArray"></circle>
                <circle class="dots" cx="50%" cy="50%" r="@segment.R"></circle>
            }

            @foreach (var segment in segments.Where(s => !s.JobStatus.Equals(JobStatuses.Accepted)))
            {
                <circle class="@segment.JobStatus.Class()" cx="50%" cy="50%" r="@segment.R" style="stroke-dashoffset: @segment.DashOffset; stroke-dasharray: @segment.DashArray"></circle>
            }


            @if (allJobsAccepted)
            {
                <path class="tick" stroke-width="3" d="M12 27.2l7.1 7 16.7-16.8" transform="rotate(90,20,25) scale(0.8)" />
            }

        </svg>
    </div>
    <span class="job__status multiple-statuses">
        @foreach (var a in unCancelledStatuses)
        {
            @($"{a.Value} {a.Key.FriendlyName()}")<br />
        }
    </span>
}